<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MarketX Pro | Premium Terminal</title>
    
    <!-- SDKs & Fonts -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&family=Noto+Sans+Arabic:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg: #000000;
            --card-bg: #0c0c0c;
            --accent: #00f2ff;
            --secondary: #bd00ff;
            --up: #00ffa3;
            --down: #ff3366;
            --text-main: #ffffff;
            --text-dim: #888;
            --border: rgba(255, 255, 255, 0.07);
            --gold: #ffd700;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', 'Noto Sans Arabic', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text-main); overflow: hidden; height: 100vh; user-select: none; }
        .app-container { width: 100%; max-width: 500px; height: 100vh; margin: 0 auto; position: relative; display: flex; flex-direction: column; background: #000; }

        /* --- Header --- */
        .header { padding: 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); z-index: 1000; }
        .logo-area { display: flex; align-items: center; gap: 10px; }
        .logo-text { font-weight: 900; font-size: 20px; background: linear-gradient(to right, #fff, var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1px; }
        .clock { font-size: 12px; color: var(--accent); font-weight: 800; background: rgba(0,242,255,0.05); padding: 5px 12px; border-radius: 20px; border: 1px solid rgba(0,242,255,0.2); }

        /* --- Navigation --- */
        .bottom-nav { position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); width: 92%; background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(25px); border-radius: 40px; display: flex; justify-content: space-around; padding: 12px; border: 1px solid var(--border); z-index: 2000; box-shadow: 0 20px 40px rgba(0,0,0,0.8); }
        .nav-item { color: #555; font-size: 22px; cursor: pointer; transition: 0.3s; padding: 10px; }
        .nav-item.active { color: var(--accent); transform: translateY(-8px); text-shadow: 0 0 15px var(--accent); }
        .nav-center { width: 60px; height: 60px; background: var(--accent); color: #000; border-radius: 50%; margin-top: -50px; border: 6px solid var(--bg); display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 10px 20px rgba(0,242,255,0.3); }

        /* --- Screens --- */
        .screen { display: none; flex: 1; padding: 20px; overflow-y: auto; padding-bottom: 140px; scrollbar-width: none; }
        .screen.active { display: block; animation: slideIn 0.4s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Global Grid & Cards --- */
        .section-title { font-size: 11px; color: var(--text-dim); margin: 25px 0 15px; display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 800; }
        .section-title i { color: var(--accent); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { background: var(--card-bg); border: 1px solid var(--border); padding: 20px; border-radius: 25px; transition: 0.3s; }
        .card.up { border-right: 4px solid var(--up); }
        .card.down { border-right: 4px solid var(--down); }
        .card-label { font-size: 10px; font-weight: 800; color: var(--text-dim); margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .price { font-size: 18px; font-weight: 900; color: #fff; }

        /* --- NEWS STYLING --- */
        .news-filters { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .filter-btn { background: var(--card-bg); border: 1px solid var(--border); color: var(--text-dim); padding: 8px 18px; border-radius: 15px; font-size: 11px; font-weight: 800; white-space: nowrap; cursor: pointer; }
        .filter-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }

        .news-card { background: var(--card-bg); border: 1px solid var(--border); padding: 18px; border-radius: 22px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px; transition: 0.3s; }
        .news-card:active { transform: scale(0.98); }
        .news-tag { display: inline-block; padding: 4px 10px; border-radius: 8px; font-size: 9px; font-weight: 900; text-transform: uppercase; }
        .tag-crypto { background: rgba(189,0,255,0.1); color: var(--secondary); }
        .tag-forex { background: rgba(0,242,255,0.1); color: var(--accent); }
        .tag-iraq { background: rgba(0,255,163,0.1); color: var(--up); }
        .news-time { font-size: 10px; color: var(--text-dim); }
        .news-title { font-size: 14px; font-weight: 700; line-height: 1.5; color: #eee; }

        /* --- AI Terminal --- */
        .ai-hero { background: radial-gradient(circle at top right, #1a0033 0%, #000 100%); border: 1px solid var(--secondary); padding: 30px 20px; border-radius: 30px; text-align: center; margin-bottom: 20px; }
        .progress-bar { height: 8px; background: rgba(255,255,255,0.05); border-radius: 10px; margin: 20px 0; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: var(--accent); box-shadow: 0 0 15px var(--accent); transition: 1s; }

        /* --- Profile --- */
        .profile-card { text-align: center; padding: 40px 20px; background: var(--card-bg); border-radius: 35px; border: 1px solid var(--border); margin-bottom: 30px; }
        .u-pfp { width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--accent); padding: 5px; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo-area">
                <div style="width:10px; height:10px; background:var(--up); border-radius:50%; box-shadow:0 0 10px var(--up);"></div>
                <div class="logo-text">MARKETX PRO</div>
            </div>
            <div id="clock" class="clock">00:00:00</div>
        </header>

        <!-- Home Screen -->
        <div id="home" class="screen active">
            <div class="section-title"><i class="fas fa-gem"></i> Metals & Gold</div>
            <div class="grid">
                <div class="card up"><div class="card-label">GOLD / USD</div><div class="price" id="price-XAU/USD">Loading...</div></div>
                <div class="card up"><div class="card-label">SILVER / USD</div><div class="price" id="price-XAG/USD">Loading...</div></div>
            </div>

            <div class="section-title"><i class="fas fa-money-bill-transfer"></i> IQD Parallel Market</div>
            <div class="grid">
                <div class="card up" style="grid-column: span 2; display: flex; justify-content: space-between; align-items: center;">
                    <div><div class="card-label">USD / IQD (Parallel)</div><div class="price">152,450</div></div>
                    <div style="background:var(--up); color:#000; padding:4px 10px; border-radius:8px; font-size:10px; font-weight:900;">BURSA LIVE</div>
                </div>
                <div class="card"><div class="card-label">EUR / IQD</div><div class="price" id="iqd-eur">164,250</div></div>
                <div class="card"><div class="card-label">GBP / IQD</div><div class="price" id="iqd-gbp">191,800</div></div>
            </div>

            <div class="section-title"><i class="fas fa-earth-americas"></i> Major Forex</div>
            <div class="grid" id="forex-grid">
                <div class="card"><div class="card-label">EUR / USD</div><div class="price" id="price-EUR/USD">--.----</div></div>
                <div class="card"><div class="card-label">GBP / USD</div><div class="price" id="price-GBP/USD">--.----</div></div>
                <div class="card"><div class="card-label">USD / JPY</div><div class="price" id="price-USD/JPY">---.--</div></div>
                <div class="card"><div class="card-label">USD / CAD</div><div class="price" id="price-USD/CAD">--.----</div></div>
            </div>
        </div>

        <!-- News Screen -->
        <div id="news" class="screen">
            <div class="section-title"><i class="fas fa-bolt"></i> Market Pulse News</div>
            <div class="news-filters">
                <div class="filter-btn active" onclick="filterNews('all', this)">All News</div>
                <div class="filter-btn" onclick="filterNews('crypto', this)">Crypto</div>
                <div class="filter-btn" onclick="filterNews('forex', this)">Forex</div>
                <div class="filter-btn" onclick="filterNews('iraq', this)">Local IQD</div>
            </div>
            <div id="news-container">
                <!-- News cards go here -->
            </div>
        </div>

        <!-- Chart Screen -->
        <div id="chart-screen" class="screen" style="padding:0; overflow:hidden;">
            <div id="tradingview_widget" style="height:100%;"></div>
        </div>

        <!-- AI Screen -->
        <div id="ai" class="screen">
            <div class="ai-hero">
                <div class="logo-text" style="font-size:24px; margin-bottom:10px;">NEURAL CORE</div>
                <div class="progress-bar"><div id="ai-progress" class="progress-fill"></div></div>
                <p id="usage-text" style="font-size:12px; color:var(--text-dim);">Ready for Market Scan...</p>
            </div>
            <div style="border:2px dashed #333; padding:40px; border-radius:30px; text-align:center;" onclick="runAI()">
                <i class="fas fa-brain" style="font-size:40px; color:var(--accent); margin-bottom:15px;"></i>
                <h3 style="font-weight:800;">Run AI Analysis</h3>
            </div>
            <div id="ai-results" style="margin-top:20px;"></div>
        </div>

        <!-- Profile Screen -->
        <div id="stars" class="screen">
            <div class="profile-card">
                <img id="u-pfp" src="https://via.placeholder.com/100" class="u-pfp">
                <h2 id="u-name" style="font-weight:900;">Trader</h2>
                <div id="u-status" style="font-size:11px; color:var(--text-dim); margin-top:8px;">Standard Member</div>
            </div>
            <div style="background:linear-gradient(90deg, #111 0%, #000 100%); padding:25px; border-radius:25px; display:flex; justify-content:space-between; align-items:center; border:1px solid var(--gold);">
                <div><h4 style="font-weight:800; color:var(--gold);">VIP PASS</h4><p style="font-size:10px; color:var(--text-dim);">Lifetime AI Access</p></div>
                <button style="background:var(--gold); color:#000; border:none; padding:12px 20px; border-radius:12px; font-weight:900;" onclick="payWithStars(49)">‚≠êÔ∏è 49</button>
            </div>
        </div>

        <!-- Navigation Bar -->
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="showTab('home', this)"><i class="fas fa-th-large"></i></div>
            <div class="nav-item" onclick="showTab('news', this)"><i class="fas fa-newspaper"></i></div>
            <div class="nav-item nav-center" onclick="showTab('chart-screen', this)"><i class="fas fa-chart-line"></i></div>
            <div class="nav-item" onclick="showTab('ai', this)"><i class="fas fa-robot"></i></div>
            <div class="nav-item" onclick="showTab('stars', this)"><i class="fas fa-user-circle"></i></div>
        </nav>
    </div>

    <!-- Scripts -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        const TD_KEY = "27a5e0dbe13d43ce99773474acbe048e";
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHFUfkDwOwDbzu9PEZlgu9NIDxCcQHbsk",
            authDomain: "marketxpro.firebaseapp.com",
            projectId: "marketxpro",
            storageBucket: "marketxpro.firebasestorage.app",
            messagingSenderId: "429949573647",
            appId: "1:429949573647:web:0175855866f9b3048d217a"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let isVIP = false;
        let usage = 0;
        let lastFetch = 0;

        // --- NEWS DATA ---
        const newsData = [
            { category: 'crypto', title: 'Bitcoin stabilizes at $65,000 as ETF inflows increase.', time: '10m ago' },
            { category: 'forex', title: 'Gold prices hit record highs amid global economic uncertainty.', time: '25m ago' },
            { category: 'iraq', title: 'Iraqi Central Bank announces new measures to stabilize Dinar.', time: '1h ago' },
            { category: 'forex', title: 'EUR/USD pair under pressure after ECB comments.', time: '2h ago' },
            { category: 'crypto', title: 'Ethereum London upgrade shows positive signs for network fees.', time: '3h ago' }
        ];

        function renderNews(filter = 'all') {
            const container = document.getElementById('news-container');
            const filtered = filter === 'all' ? newsData : newsData.filter(n => n.category === filter);
            
            container.innerHTML = filtered.map(n => `
                <div class="news-card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="news-tag tag-${n.category}">${n.category}</span>
                        <span class="news-time">${n.time}</span>
                    </div>
                    <div class="news-title">${n.title}</div>
                </div>
            `).join('');
        }

        function filterNews(cat, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderNews(cat);
            tg.HapticFeedback.impactOccurred('light');
        }

        // --- MARKET LOGIC ---
        async function fetchMarket() {
            const now = Date.now();
            if (now - lastFetch < 75000) return;
            lastFetch = now;

            try {
                const symbols = "XAU/USD,XAG/USD,EUR/USD,GBP/USD,USD/JPY,USD/CAD";
                const res = await fetch(`https://api.twelvedata.com/price?symbol=${symbols}&apikey=${TD_KEY}`);
                const data = await res.json();
                
                if (data.status !== "error") {
                    for (const [sym, info] of Object.entries(data)) {
                        const el = document.getElementById(`price-${sym}`);
                        if (el) {
                            let p = parseFloat(info.price);
                            el.innerText = sym.includes("USD/") && !sym.includes("JPY") ? p.toFixed(4) : p.toFixed(2);
                        }
                    }
                    // IQD calculation
                    const usdRate = 1524.50;
                    document.getElementById('iqd-eur').innerText = (parseFloat(data["EUR/USD"].price) * usdRate * 100).toLocaleString().split('.')[0];
                    document.getElementById('iqd-gbp').innerText = (parseFloat(data["GBP/USD"].price) * usdRate * 100).toLocaleString().split('.')[0];
                }
            } catch (e) { console.error(e); }
        }

        // --- CORE UI ---
        function showTab(id, btn) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
            if (id === 'chart-screen') {
                document.getElementById('tradingview_widget').innerHTML = '';
                new TradingView.widget({ "autosize": true, "symbol": "OANDA:XAUUSD", "interval": "15", "theme": "dark", "container_id": "tradingview_widget", "hide_side_toolbar": true });
            }
            tg.HapticFeedback.impactOccurred('medium');
        }

        async function syncUser() {
            const user = tg.initDataUnsafe?.user || { id: "test", first_name: "Trader" };
            const doc = await db.collection("users").doc(user.id.toString()).get();
            const data = doc.exists() ? doc.data() : { name: user.first_name, isVIP: false, usage: 0 };
            if (!doc.exists()) await db.collection("users").doc(user.id.toString()).set(data);
            
            isVIP = data.isVIP; usage = data.usage;
            document.getElementById('u-name').innerText = data.name;
            if (tg.initDataUnsafe?.user?.photo_url) document.getElementById('u-pfp').src = tg.initDataUnsafe.user.photo_url;
            
            if (isVIP) {
                document.getElementById('u-status').innerText = "VIP PREMIUM ACCOUNT";
                document.getElementById('u-status').style.color = "var(--gold)";
                document.getElementById('ai-progress').style.width = "100%";
                document.getElementById('usage-text').innerText = "UNLIMITED ACCESS";
            } else {
                document.getElementById('ai-progress').style.width = (usage / 3 * 100) + "%";
                document.getElementById('usage-text').innerText = `Scans Used: ${usage} of 3 Free`;
            }
        }

        async function runAI() {
            if (!isVIP && usage >= 3) { alert("Upgrade to VIP!"); return; }
            document.getElementById('ai-progress').style.width = "100%";
            setTimeout(async () => {
                usage++;
                await db.collection("users").doc(tg.initDataUnsafe.user.id.toString()).update({ usage: usage });
                alert("ü§ñ AI ANALYSIS:\nGOLD (XAU/USD): Bullish detected.\nConfidence: 89%");
                syncUser();
            }, 1000);
        }

        async function payWithStars(amt) {
            tg.showConfirm(`Confirm payment of ‚≠êÔ∏è ${amt} for Lifetime VIP?`, async (ok) => {
                if (ok) {
                    await db.collection("users").doc(tg.initDataUnsafe.user.id.toString()).update({ isVIP: true });
                    location.reload();
                }
            });
        }

        setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-GB'), 1000);
        setInterval(fetchMarket, 80000);

        window.onload = () => {
            tg.expand();
            syncUser();
            fetchMarket();
            renderNews();
        };
    </script>
</body>
</html>