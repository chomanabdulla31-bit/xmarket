<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MarketX Pro | Live Terminal</title>
    
    <!-- SDKs & Fonts -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=Noto+Sans+Arabic:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg: #000000; --card: #0a0a0a;
            --accent: #00f2ff; --secondary: #bd00ff;
            --up: #00ffa3; --down: #ff3366;
            --text: #ffffff; --text-dim: #777;
            --glass-border: rgba(255, 255, 255, 0.08);
            --vip-gold: #ffd700;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', 'Noto Sans Arabic', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text); overflow: hidden; height: 100vh; user-select: none; }
        .app-container { width: 100%; max-width: 500px; height: 100vh; margin: 0 auto; position: relative; display: flex; flex-direction: column; }

        /* --- Header --- */
        .main-header { padding: 18px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); z-index: 1000; border-bottom: 1px solid var(--glass-border); }
        .logo-text { font-weight: 900; font-size: 22px; background: linear-gradient(to right, #fff, var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1px; }
        .status-dot { width: 8px; height: 8px; background: var(--up); border-radius: 50%; box-shadow: 0 0 10px var(--up); display: inline-block; margin-left: 5px; }

        /* --- Navigation --- */
        nav.bottom-bar { position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); width: 92%; background: rgba(10, 10, 10, 0.98); backdrop-filter: blur(25px); border-radius: 40px; display: flex; justify-content: space-around; padding: 14px; border: 1px solid var(--glass-border); z-index: 2000; box-shadow: 0 15px 35px rgba(0,0,0,0.7); }
        .nav-btn { color: #444; font-size: 22px; cursor: pointer; transition: 0.3s; }
        .nav-btn.active { color: var(--accent); transform: translateY(-5px); text-shadow: 0 0 15px var(--accent); }
        .meta-btn { width: 55px; height: 55px; background: var(--accent); color: #000; border-radius: 50%; margin-top: -45px; border: 6px solid var(--bg); display: flex; align-items: center; justify-content: center; font-size: 22px; box-shadow: 0 5px 15px rgba(0,242,255,0.4); }

        /* --- Screens --- */
        .screen { display: none; flex: 1; padding: 20px; overflow-y: auto; padding-bottom: 140px; animation: screenIn 0.4s ease-out; }
        .screen.active { display: block; }
        @keyframes screenIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* --- UI Components --- */
        .section-title { font-size: 11px; color: var(--text-dim); margin: 25px 0 12px; display: flex; align-items: center; justify-content: space-between; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 800; }
        .section-title i { color: var(--accent); font-size: 14px; }

        .asset-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .asset-card { background: var(--card); border: 1px solid var(--glass-border); padding: 18px; border-radius: 22px; transition: 0.3s; position: relative; }
        .asset-card:active { transform: scale(0.97); }
        .asset-card.up { border-right: 4px solid var(--up); }
        .asset-card.down { border-right: 4px solid var(--down); }
        
        .card-head { display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 700; color: var(--text-dim); }
        .card-head i { font-size: 14px; color: var(--accent); }
        .price-val { font-size: 18px; font-weight: 900; margin-top: 10px; color: #fff; }
        .change-val { font-size: 10px; margin-top: 4px; font-weight: bold; }

        /* --- Special Cards --- */
        .full-card { grid-column: span 2; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #0a0a0a 0%, #111 100%); }
        .badge { background: var(--up); color: #000; font-size: 9px; padding: 3px 8px; border-radius: 6px; font-weight: 900; }

        /* --- AI Section --- */
        .ai-hero { background: radial-gradient(circle at top right, #1a0033 0%, #000 100%); border: 1px solid var(--secondary); padding: 30px 20px; border-radius: 30px; text-align: center; margin-bottom: 25px; }
        .progress-box { height: 8px; background: rgba(255,255,255,0.05); border-radius: 10px; margin: 20px 0; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: var(--accent); box-shadow: 0 0 15px var(--accent); transition: 1s; }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="main-header">
            <div class="logo-text"><span class="status-dot"></span>MARKETX PRO</div>
            <div id="clock" style="font-size: 13px; font-weight: 900; color: var(--accent);">00:00:00</div>
        </header>

        <!-- Home Screen -->
        <div id="home" class="screen active">
            <!-- Metals -->
            <div class="section-title"><span><i class="fas fa-gem"></i> METALS & COMMODITIES</span></div>
            <div class="asset-grid">
                <div class="asset-card up">
                    <div class="card-head"><i class="fas fa-coins"></i> GOLD (Z√äR)</div>
                    <div class="price-val" id="price-XAU/USD">Loading...</div>
                    <div class="change-val" style="color:var(--up)">OANDA LIVE</div>
                </div>
                <div class="asset-card up">
                    <div class="card-head"><i class="fas fa-ring"></i> SILVER (Z√éV)</div>
                    <div class="price-val" id="price-XAG/USD">Loading...</div>
                    <div class="change-val" style="color:var(--up)">OANDA LIVE</div>
                </div>
            </div>

            <!-- IQD Market -->
            <div class="section-title"><span><i class="fas fa-money-bill-1-wave"></i> IQD PARALLEL MARKET</span></div>
            <div class="asset-grid">
                <div class="asset-card full-card up">
                    <div>
                        <div class="card-head"><i class="fas fa-dollar-sign"></i> USD / IQD (BURSA)</div>
                        <div class="price-val" id="iqd-usd">152,450</div>
                    </div>
                    <span class="badge">LIVE RATE</span>
                </div>
                <div class="asset-card up">
                    <div class="card-head"><i class="fas fa-euro-sign"></i> EUR / IQD</div>
                    <div class="price-val" id="iqd-eur">164,200</div>
                </div>
                <div class="asset-card up">
                    <div class="card-head"><i class="fas fa-pound-sign"></i> GBP / IQD</div>
                    <div class="price-val" id="iqd-gbp">191,850</div>
                </div>
            </div>

            <!-- Global Forex -->
            <div class="section-title"><span><i class="fas fa-earth-americas"></i> MAJOR CURRENCIES</span></div>
            <div class="asset-grid" id="forex-grid">
                <div class="asset-card"><div class="card-head">EUR / USD</div><div class="price-val" id="price-EUR/USD">---</div></div>
                <div class="asset-card"><div class="card-head">GBP / USD</div><div class="price-val" id="price-GBP/USD">---</div></div>
                <div class="asset-card"><div class="card-head">USD / JPY</div><div class="price-val" id="price-USD/JPY">---</div></div>
                <div class="asset-card"><div class="card-head">AUD / USD</div><div class="price-val" id="price-AUD/USD">---</div></div>
                <div class="asset-card"><div class="card-head">USD / CAD</div><div class="price-val" id="price-USD/CAD">---</div></div>
                <div class="asset-card"><div class="card-head">USD / CHF</div><div class="price-val" id="price-USD/CHF">---</div></div>
            </div>

            <!-- Crypto -->
            <div class="section-title"><span><i class="fab fa-bitcoin"></i> CRYPTO ASSETS</span></div>
            <div class="asset-grid" id="crypto-grid">
                <div style="color:var(--text-dim); padding:10px;">Connecting to Binance...</div>
            </div>
        </div>

        <!-- AI Screen -->
        <div id="ai" class="screen">
            <div class="ai-hero">
                <h2 style="font-weight:900; color:var(--accent); letter-spacing:-1px;">AI NEURAL CORE</h2>
                <div class="progress-box"><div id="ai-progress" class="progress-fill"></div></div>
                <p id="usage-text" style="font-size:12px; color:var(--text-dim);">Analyzing market trends...</p>
            </div>
            <div style="border:2px dashed #222; padding:40px; border-radius:30px; text-align:center;" onclick="runAI()">
                <i class="fas fa-brain" style="font-size:40px; color:var(--accent); margin-bottom:15px;"></i>
                <h3 style="font-weight:800;">START SMART SCAN</h3>
            </div>
            <div id="ai-list" style="margin-top:20px;"></div>
        </div>

        <!-- Chart Screen -->
        <div id="chart-screen" class="screen" style="padding:0; overflow:hidden;">
            <div id="tradingview_widget" style="height:100%;"></div>
        </div>

        <!-- Stars / Profile -->
        <div id="stars" class="screen">
            <div class="profile-hero" style="text-align:center; padding:40px 20px; background:var(--card); border-radius:30px;">
                <img id="u-pfp" src="https://via.placeholder.com/100" style="width:100px; height:100px; border-radius:50%; border:3px solid var(--accent); padding:5px; margin-bottom:15px;">
                <h2 id="u-name" style="font-weight:900;">Trader</h2>
                <div id="account-status" style="font-size:11px; color:var(--text-dim); margin-top:8px;">STANDARD ACCOUNT</div>
            </div>
            <div style="background:linear-gradient(90deg, #001f3f 0%, #000 100%); padding:20px; border-radius:22px; display:flex; justify-content:space-between; align-items:center; margin-top:20px; border:1px solid #0088cc;">
                <div><h4 style="font-weight:800;">VIP PASS</h4><small style="color:#00ffa3;">Lifetime Signal Access</small></div>
                <button style="background:#0088cc; color:#fff; border:none; padding:10px 20px; border-radius:12px; font-weight:900;" onclick="payWithStars(49)">‚≠êÔ∏è 49</button>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="bottom-bar">
            <div class="nav-btn active" onclick="showTab('home', this)"><i class="fas fa-chart-pie"></i></div>
            <div class="nav-btn" onclick="showTab('ai', this)"><i class="fas fa-robot"></i></div>
            <div class="nav-btn meta-btn" onclick="showTab('chart-screen', this)"><i class="fas fa-chart-line"></i></div>
            <div class="nav-btn" onclick="showTab('stars', this)"><i class="fas fa-user-circle"></i></div>
        </nav>
    </div>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDHFUfkDwOwDbzu9PEZlgu9NIDxCcQHbsk",
            authDomain: "marketxpro.firebaseapp.com",
            projectId: "marketxpro",
            storageBucket: "marketxpro.firebasestorage.app",
            messagingSenderId: "429949573647",
            appId: "1:429949573647:web:0175855866f9b3048d217a"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const tg = window.Telegram.WebApp;
        const TD_KEY = "27a5e0dbe13d43ce99773474acbe048e";
        let isVIP = false;
        let usage = 0;

        // --- MARKET ENGINE ---
        async function fetchForex() {
            const symbols = "XAU/USD,XAG/USD,EUR/USD,GBP/USD,USD/JPY,AUD/USD,USD/CAD,USD/CHF";
            try {
                const res = await fetch(`https://api.twelvedata.com/price?symbol=${symbols}&apikey=${TD_KEY}`);
                const data = await res.json();
                
                if (data.status === "error") {
                    console.error("Twelve Data Limit Reached");
                    return;
                }

                for (const [sym, info] of Object.entries(data)) {
                    const el = document.getElementById(`price-${sym}`);
                    if (el) {
                        let p = parseFloat(info.price);
                        el.innerText = sym.includes("USD/") && !sym.includes("JPY") ? p.toFixed(4) : p.toFixed(2);
                    }
                }

                // Update IQD conversion based on parallel rate (152,450)
                const usdIqd = 1524.50; 
                if (data["EUR/USD"]) document.getElementById('iqd-eur').innerText = (parseFloat(data["EUR/USD"].price) * usdIqd * 100).toLocaleString().split('.')[0];
                if (data["GBP/USD"]) document.getElementById('iqd-gbp').innerText = (parseFloat(data["GBP/USD"].price) * usdIqd * 100).toLocaleString().split('.')[0];

            } catch (e) { console.error("Forex Fetch Fail"); }
        }

        async function fetchCrypto() {
            try {
                const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,solana,binancecoin&vs_currencies=usd&include_24hr_change=true`);
                const data = await res.json();
                const list = [{id:"bitcoin",s:"BTC"},{id:"ethereum",s:"ETH"},{id:"solana",s:"SOL"},{id:"binancecoin",s:"BNB"}];
                
                document.getElementById('crypto-grid').innerHTML = list.map(c => {
                    const d = data[c.id];
                    const t = d.usd_24h_change >= 0 ? "up" : "down";
                    return `
                        <div class="asset-card ${t}">
                            <div class="card-head">${c.s} / USD</div>
                            <div class="price-val">$${d.usd.toLocaleString()}</div>
                            <div class="change-val" style="color:var(--${t})">${d.usd_24h_change.toFixed(2)}%</div>
                        </div>`;
                }).join('');
            } catch (e) { console.error("Crypto Fetch Fail"); }
        }

        // --- APP LOGIC ---
        function showTab(id, btn) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
            if(id === 'chart-screen') {
                document.getElementById('tradingview_widget').innerHTML = '';
                new TradingView.widget({ "autosize": true, "symbol": "OANDA:XAUUSD", "interval": "15", "theme": "dark", "container_id": "tradingview_widget", "hide_side_toolbar": true });
            }
            tg.HapticFeedback.impactOccurred('light');
        }

        async function syncUser() {
            const user = tg.initDataUnsafe?.user || { id: "test", first_name: "Trader" };
            const doc = await db.collection("users").doc(user.id.toString()).get();
            if (doc.exists()) {
                const data = doc.data();
                isVIP = data.isVIP;
                usage = data.usage;
                document.getElementById('u-name').innerText = data.name;
                if(isVIP) {
                    document.getElementById('account-status').innerText = "VIP PREMIUM ACCOUNT";
                    document.getElementById('account-status').style.color = "var(--vip-gold)";
                }
            } else {
                await db.collection("users").doc(user.id.toString()).set({ name: user.first_name, isVIP: false, usage: 0 });
            }
            updateAIUI();
        }

        async function runAI() {
            if(!isVIP && usage >= 3) { alert("Please Upgrade to VIP!"); return; }
            document.getElementById('ai-progress').style.width = "100%";
            setTimeout(async () => {
                usage++;
                const user = tg.initDataUnsafe?.user || { id: "test" };
                await db.collection("users").doc(user.id.toString()).update({ usage: usage });
                alert("ü§ñ AI ANALYSIS:\n\nGOLD (XAU): Bullish detected.\nTarget: 2185.00\nConfidence: 86%");
                location.reload();
            }, 1000);
        }

        function updateAIUI() {
            const fill = document.getElementById('ai-progress');
            if(isVIP) { fill.style.width = "100%"; document.getElementById('usage-text').innerText = "UNLIMITED ACCESS"; }
            else { fill.style.width = (usage/3*100)+"%"; document.getElementById('usage-text').innerText = `Usage: ${usage}/3 Free Scans`; }
        }

        // Init
        setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-GB'), 1000);
        setInterval(fetchForex, 75000); // 75 seconds for API safety
        setInterval(fetchCrypto, 60000);

        window.onload = () => {
            tg.expand();
            syncUser();
            fetchForex();
            fetchCrypto();
            if(tg.initDataUnsafe?.user?.photo_url) document.getElementById('u-pfp').src = tg.initDataUnsafe.user.photo_url;
            
            document.getElementById('ai-list').innerHTML = `
                <div style="background:var(--card); padding:15px; border-radius:15px; border-left:4px solid var(--up); margin-bottom:10px;"><strong>GOLD FORECAST</strong><br><small>Trend: Bullish | Conf: 88%</small></div>
                <div style="background:var(--card); padding:15px; border-radius:15px; border-left:4px solid var(--down);"><strong>EUR/USD FORECAST</strong><br><small>Trend: Bearish | Conf: 62%</small></div>
            `;
        };
    </script>
</body>
</html>